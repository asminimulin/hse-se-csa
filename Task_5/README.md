# Пятое задание в курсе "Архитектура вычислительных систем" на 2 курсе ОП Программная инженерия в НИУ ВШЭ

## Описание задания
**Вариант задания: 21**

### Постановка задачи
В библиотеке есть M рядов по N шкафов по K книг в каждом. Требуется составить каталог.

### Ограничения 
Необходимо написать консольное приложение, решающее поставленную задачу которое соответсвует следующим требованиям:
1. Приложение написано на языке C++ с использованием стандартной библиотеки для работы с потоками ОС.
2. Программа должна компилироваться компилятором g++ версии 9.3.0 в ОС linux.
3. Программа должна содержать реализацию модели многопоточного приложения **взаимодействующие равные**, конкретнее:
    реализацию указанной модели с помощью метода **портфель задач**, за отдельную задачу принять составление каталога
    для одного ряда.

<hr>

## Реализация
1. В силу того, что ввод из stdin нельзя осуществлять параллельно в данной задаче все входные данные  передаются 
   через аргументы командной строки, этих аргументов три: `-m ROWS -n BOOKCASES_PER_ROW -k  BOOKS_PER_BOOKCASE`, а 
   данные книг в данной библиотеки будут сгенерированны.
2. Если один из параметров пропущен, то его значение принимается равным `10`.
3. Аналогично потоку stdin в поток stdout нельзя параллельно писать, поэтому вывод в программе минимален: 
   пользователь увидит время, затраченное на генерацию исходных данных, и суммарное время, 
   затраченное на выполнение шага создания каталогов для всех рядов. После создания каталогов пользователю будет 
   предложено просмотреть их содержимое: через диалоговое сообщение `Show catalogs? (Y/y - yes, N/n - no)`. Если 
   пользователь отвечает `Y` или `y`, то в стандратный поток вывода последовательно печатается содержимое каждого 
   каталога. Любой другой ответ пользователя трактуется как отказ от вывода содержимого кататалогов.
4. Реализация метода **портфель задач** осуществляется классом `ThreadPool`(thread_pool/thread_pool.hpp), 
   разделяемой переменной является атомарный счётчик `ThreadPool::m_remaining_tasks`, декрементируя который потоки, 
   запущенные данным пулом потоков, выбирают себе задачу на выполнение.
5. Указанный в предыдущем пункте ThreadPool используется в прогрмме дважды: при генерации исходных данных (см. 
   реализацию функции `GenerateBooksDistribution` в файле `generator/generate_books_distribution.cpp`) и при 
   составлении каталогов для каждого из рядов (см. реализцию функции `Catalog::CreateCatalogs` в файле 
   `library/catalog.cpp`).
6. Программа написана на языке C++ с использованием стандарта языка C++20.

## Сборка программы.
Сборка программы осуществляется с помощью системы сборки проектов CMake.

```
# CMake configure step.
$ cmake . -B build -DCMAKE_BUILD_TYPE=Release
# CMake build step.
$ cmake --build build
```
После сборки в корне репозитория появится папка `bin`, в которой будет расположен полученный исполняемый файл 
`inventory`.

## Тестирование
Запуск теста состоит в исполнении файла `./bin/inventory` с нужными параметрами при необходимости.
```
$ ./bin/inventory -m 10 -n 100 -k 1000
```

Замеры времени выполнения при разном количестве рядов
|Команда | Время, затрчаенное на генерацию данных, с | Время, затраченное на создание каталогов, с
:---: | :---: | :---:
`./bin/inventory -m 1 -n 1000 -k 10000` | 9.72841 | 9.87219
`./bin/inventory -m 2 -n 500 -k 10000` | 5.2117 | 5.93886
`./bin/inventory -m 4 -n 250 -k 10000` | 3.23605 | 3.4078
`./bin/inventory -m 8 -n 125 -k 10000` | 2.12169 |  2.39123
`./bin/inventory -m 16 -n 125 -k 5000` | 2.74982 | 2.41217
`./bin/inventory -m 32 -n 125 -k 2500` | 2.15515 |  2.43843

Видно, что при дальнейшем увеличении количества задач в портфеле после 8, время работы не улучшается. Это связано с тем,
что на машине, на которой проводится тестирование утсановлен 8-ядерный процессор без, т.е. не может быть более 8 
одновременно выполняеющихся потоков.

## Источники
* [Документация по языку C++](https://en.cppreference.com/w/cpp)
